name: WINDOWS_10_VNC_FINAL_FIX
on: 
  workflow_dispatch:

jobs:
  deploy_vm:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: üì• 1. INSTALAR MOTOR Y ISO
        shell: powershell
        run: |
          choco install qemu ngrok -y
          Write-Host "[*] Descargando Windows 10 Limpio..." -ForegroundColor Cyan
          curl.exe -L -o win10.iso "https://archive.org/download/tiny-10-NTDEV/tiny10%2023h1%20x64.iso"

      - name: üöÄ 2. LANZAR VM
        shell: powershell
        run: |
          & "C:\Program Files\qemu\qemu-img.exe" create -f qcow2 win10_clean.qcow2 100G
          Start-Process "C:\Program Files\qemu\qemu-system-x86_64.exe" -ArgumentList `
            "-m 10G", `
            "-smp 4,cores=4", `
            "-cpu host,kvm=off,hv_vendor_id=null", `
            "-drive file=win10_clean.qcow2,format=qcow2", `
            "-cdrom win10.iso", `
            "-vga virtio", `
            "-display none", `
            "-vnc :0", `
            "-net nic,model=e1000", `
            "-net user", `
            "-accel whpx"

      - name: üåê 3. CONECTAR NGROK
        shell: powershell
        run: |
          $NGROK_TOKEN = "377nhcufrMXbsEoPizYP8xnS22I_WaaTwHifh1DN6doMG5jU"
          & ngrok config add-authtoken $NGROK_TOKEN
          
          Write-Host "[*] Iniciando Ngrok en modo persistente..." -ForegroundColor Yellow
          # Lanzamos ngrok usando CMD para asegurar que el proceso se mantenga
          $ngrokProcess = Start-Process cmd -ArgumentList "/c ngrok tcp 5900 --log=stdout" -PassThru -WindowStyle Hidden
          
          Write-Host "[*] Esperando 30 segundos para estabilidad..." -ForegroundColor Cyan
          Start-Sleep -Seconds 30
          
          $ngrok_url = ""
          $attempts = 0
          while ($attempts -lt 10) {
              try {
                  $response = curl.exe -s http://localhost:4040/api/tunnels | ConvertFrom-Json
                  $ngrok_url = $response.tunnels[0].public_url
                  if ($ngrok_url) { break }
              } catch {
                  Write-Host "[!] Buscando tunel... (Intento $attempts)"
              }
              $attempts++
              Start-Sleep -Seconds 10
          }
          
          if (-not $ngrok_url) {
              Write-Host "[-] Ngrok API no responde. Intentando lectura de logs..." -ForegroundColor Orange
              # Plan B: Si la API falla, ngrok a veces necesita un empuj√≥n
              & ngrok tcp 5900 --log=stdout &
              Start-Sleep -Seconds 20
              $response = curl.exe -s http://localhost:4040/api/tunnels | ConvertFrom-Json
              $ngrok_url = $response.tunnels[0].public_url
          }

          if ($ngrok_url) {
              Write-Host "################################################" -ForegroundColor Green
              Write-Host "IP PARA TU CELULAR: $ngrok_url" -ForegroundColor White
              Write-Host "################################################" -ForegroundColor Green
          } else {
              Write-Host "[-] No se pudo obtener la IP. Revisa si el Token es correcto." -ForegroundColor Red
              exit 1
          }
          
          while($true) { Start-Sleep -Seconds 60 }
          
