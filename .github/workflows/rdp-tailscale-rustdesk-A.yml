name: WINDOWS_10_PURE_CLOUDFLARE
on: 
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: ðŸ“¥ 1. INSTALAR QEMU Y CLOUDFLARE
        shell: powershell
        run: |
          choco install qemu cloudflared -y
          Write-Host "[*] Descargando Windows 10 Limpio..." -ForegroundColor Cyan
          curl.exe -L -o win10.iso "https://archive.org/download/tiny-10-NTDEV/tiny10%2023h1%20x64.iso"

      - name: ðŸš€ 2. LANZAR VM
        shell: powershell
        run: |
          & "C:\Program Files\qemu\qemu-img.exe" create -f qcow2 win10_clean.qcow2 100G
          Start-Process "C:\Program Files\qemu\qemu-system-x86_64.exe" -ArgumentList `
            "-m 10G", `
            "-smp 4,cores=4", `
            "-cpu host,kvm=off,hv_vendor_id=null", `
            "-drive file=win10_clean.qcow2,format=qcow2", `
            "-cdrom win10.iso", `
            "-vga virtio", `
            "-display none", `
            "-vnc :0", `
            "-net nic,model=e1000", `
            "-net user", `
            "-accel whpx"

      - name: ðŸŒ 3. GENERAR IP PUBLICA
        shell: powershell
        run: |
          Write-Host "[*] Iniciando Tunel de Cloudflare..." -ForegroundColor Yellow
          
          # Lanzamos el tunel y guardamos el log para extraer la URL
          Start-Process cmd -ArgumentList "/c cloudflared tunnel --url tcp://localhost:5900 > cf.log 2>&1"
          
          Write-Host "[*] Esperando 20 segundos para obtener la direccion..." -ForegroundColor Cyan
          Start-Sleep -Seconds 20
          
          # Buscamos la URL en el archivo de log
          $cf_url = Get-Content "cf.log" | Select-String -Pattern "https://.*\.trycloudflare\.com" | ForEach-Object { $_.Matches.Value }
          
          if ($cf_url) {
              Write-Host "################################################" -ForegroundColor Green
              Write-Host "TU URL DE CONEXION ES: $cf_url" -ForegroundColor White
              Write-Host "################################################" -ForegroundColor Green
              Write-Host "Nota: Si usas VNC Viewer, usa el modo TCP con esa URL."
          } else {
              Write-Host "[-] No se detecto URL automatica. Mostrando logs para copia manual:" -ForegroundColor Orange
              Get-Content "cf.log"
          }
          
          while($true) { Start-Sleep -Seconds 60 }
          
