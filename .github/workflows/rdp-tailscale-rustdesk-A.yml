name: WIN11_NVIDIA_TRAY_GODMODE
on: 
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: ðŸŽ­ 1. HARDWARE SPOOFING (NIVEL KERNEL-LOOKALIKE)
        shell: powershell
        run: |
          Write-Host "[*] Iniciando Secuencia de Camuflaje Avanzado..." -ForegroundColor Cyan

          # --- A. CPU SPOOF (Ryzen 9 7950X3D) ---
          $cpuPath = "HKLM:\HARDWARE\DESCRIPTION\System\CentralProcessor"
          try {
              $cores = Get-ChildItem -Path $cpuPath
              foreach ($core in $cores) {
                  # Cambiamos nombre y vendor para que parezca AMD legitimo
                  Set-ItemProperty -Path $core.PSPath -Name "ProcessorNameString" -Value "AMD Ryzen 9 7950X3D 16-Core Processor" -ErrorAction SilentlyContinue
                  Set-ItemProperty -Path $core.PSPath -Name "VendorIdentifier" -Value "AuthenticAMD" -ErrorAction SilentlyContinue
              }
              Write-Host "[+] CPU: Identidad suplantada con exito." -ForegroundColor Green
          } catch { Write-Host "[-] Advertencia en CPU Spoof" -ForegroundColor Red }

          # --- B. GPU SPOOF (Busqueda Profunda de Hyper-V) ---
          Write-Host "[*] Inyectando identidad NVIDIA RTX 4090..." -ForegroundColor Yellow
          $rootPaths = @("HKLM:\SYSTEM\CurrentControlSet\Enum\PCI", "HKLM:\SYSTEM\CurrentControlSet\Enum\ACPI")
          
          foreach ($root in $rootPaths) {
              Get-ChildItem -Path $root -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
                  try {
                      $prop = $_ | Get-ItemProperty -Name "FriendlyName" -ErrorAction SilentlyContinue
                      if ($prop) {
                          $name = $prop.FriendlyName
                          # Detectamos cualquier driver de video generico
                          if ($name -match "Hyper-V" -or $name -match "Microsoft" -or $name -match "Display Adapter") {
                              Set-ItemProperty -Path $_.PSPath -Name "FriendlyName" -Value "NVIDIA GeForce RTX 4090" -Force
                              Set-ItemProperty -Path $_.PSPath -Name "DeviceDesc" -Value "NVIDIA GeForce RTX 4090" -Force
                              # Cambiamos el fabricante a NVIDIA
                              Set-ItemProperty -Path $_.PSPath -Name "Mfg" -Value "NVIDIA" -Force
                              Write-Host "[+] GPU en registro $($_.PSName) -> RTX 4090" -ForegroundColor Green
                          }
                      }
                  } catch {}
              }
          }

          # --- C. SYSTEM INFO (Motherboard ASUS) ---
          $bios = "HKLM:\HARDWARE\DESCRIPTION\System\BIOS"
          Set-ItemProperty -Path $bios -Name "SystemManufacturer" -Value "ASUS" -ErrorAction SilentlyContinue
          Set-ItemProperty -Path $bios -Name "SystemProductName" -Value "ROG CROSSHAIR X670E HERO" -ErrorAction SilentlyContinue

      - name: ðŸŸ¢ 2. INYECTAR SYSTEM TRAY ICON (NVIDIA)
        shell: powershell
        run: |
          Write-Host "[*] Compilando script de System Tray..." -ForegroundColor Cyan
          
          # 1. Descargar el icono oficial de NVIDIA (.ico)
          $iconPath = "C:\Users\Public\nvidia.ico"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/fajardos87/icons/main/nvidia.ico" -OutFile $iconPath -ErrorAction SilentlyContinue
          
          # Si falla la descarga, usamos un icono generico del sistema para que no falle el script
          if (-not (Test-Path $iconPath)) {
              Write-Host "[!] Usando icono de sistema por fallo de descarga." -ForegroundColor Yellow
              $iconPath = "C:\Windows\System32\shell32.dll" # Fallback
          }

          # 2. Crear el script "Fantasma" que mantendra el icono vivo
          $trayScript = @"
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          \$notify = New-Object System.Windows.Forms.NotifyIcon
          try {
              \$notify.Icon = [System.Drawing.Icon]::ExtractAssociatedIcon("$iconPath")
          } catch {
              \$notify.Icon = [System.Drawing.Icon]::ExtractAssociatedIcon("C:\Windows\regedit.exe")
          }
          
          \$notify.Text = "NVIDIA Settings - RTX 4090"
          \$notify.Visible = \$True
          
          # Crear menu contextual (Click derecho)
          \$menu = New-Object System.Windows.Forms.ContextMenu
          \$item1 = \$menu.MenuItems.Add("NVIDIA Control Panel")
          \$item1.add_Click({ Start-Process "dxdiag.exe" })
          \$item2 = \$menu.MenuItems.Add("GeForce Experience")
          \$item3 = \$menu.MenuItems.Add("-")
          \$item4 = \$menu.MenuItems.Add("Exit")
          \$item4.add_Click({ \$notify.Visible = \$False; [System.Windows.Forms.Application]::Exit() })
          
          \$notify.ContextMenu = \$menu
          
          # Bucle infinito de UI para mantener el icono
          \$ctx = New-Object System.Windows.Forms.ApplicationContext
          [System.Windows.Forms.Application]::Run(\$ctx)
          "@
          
          $trayScript | Out-File -Encoding UTF8 "C:\Users\Public\FakeNvidiaTray.ps1"
          
          # 3. Lanzar el proceso en segundo plano (Hidden)
          Write-Host "[*] Lanzando proceso NVIDIA Container (Fake)..." -ForegroundColor Green
          Start-Process powershell -ArgumentList "-NoProfile -ExecutionPolicy Bypass -File C:\Users\Public\FakeNvidiaTray.ps1" -WindowStyle Hidden

      - name: ðŸ’¾ 3. DISCO 1TB (DINAMICO EXACTO)
        shell: powershell
        run: |
          New-VHD -Path "C:\GamingStorage.vhdx" -SizeBytes 1025GB -Dynamic
          $vhd = Mount-VHD -Path "C:\GamingStorage.vhdx" -PassThru
          $disk = $vhd | Get-Disk
          Initialize-Disk -Number $disk.Number -PartitionStyle GPT
          $partition = New-Partition -DiskNumber $disk.Number -UseMaximumSize -AssignDriveLetter
          Format-Volume -DriveLetter $partition.DriveLetter -FileSystem NTFS -NewFileSystemLabel "Disco" -Confirm:$false

      - name: ðŸ”‘ 4. INSTALAR RUSTDESK
        shell: powershell
        run: |
          curl.exe -L -o rd.msi "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi"
          Start-Process msiexec.exe -ArgumentList "/i rd.msi /quiet /norestart" -Wait
          Start-Sleep -Seconds 15
          & "C:\Program Files\RustDesk\rustdesk.exe" --password Bullet123
          
          $id = ""
          for ($i=0; $i -lt 15; $i++) {
              $id = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id
              if ($id) { break }
              Start-Sleep -Seconds 5
          }
          Write-Host "################################################" -ForegroundColor Yellow
          Write-Host "ID RUSTDESK: $id" -ForegroundColor Green
          Write-Host "CLAVE: Bullet123" -ForegroundColor Green
          Write-Host "################################################" -ForegroundColor Yellow

      - name: ðŸ“¸ 5. CAPTURA DE PRUEBA A CATBOX
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Windows.Forms
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"
          Start-Sleep -Seconds 5
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($screen.Width, $screen.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($screen.Left, $screen.Top, 0, 0, $bitmap.Size)
          $bitmap.Save("C:\Users\Public\proof.png")
          
          $link = curl.exe -F "reqtype=fileupload" -F "fileToUpload=@C:\Users\Public\proof.png" https://catbox.moe/user/api.php
          Write-Host "CAPTURA DISPONIBLE: $link" -ForegroundColor Cyan

      - name: ðŸ”„ MANTENER VIVO
        shell: powershell
        run: |
          while($true) { Start-Sleep -Seconds 60 }
          
