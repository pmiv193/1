name: WINDOWS_10_ULTIMATE_VNC
on: 
  workflow_dispatch:

jobs:
  deploy_vm:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: üì• 1. INSTALAR MOTOR Y ISO
        shell: powershell
        run: |
          # Instalamos QEMU y Ngrok
          choco install qemu ngrok -y
          
          Write-Host "[*] Descargando Tiny10 x64 (Windows 10 Limpio)..." -ForegroundColor Cyan
          curl.exe -L -o win10.iso "https://archive.org/download/tiny-10-NTDEV/tiny10%2023h1%20x64.iso"

      - name: üöÄ 2. LANZAR WINDOWS 10
        shell: powershell
        run: |
          # Creamos el disco de 100GB
          & "C:\Program Files\qemu\qemu-img.exe" create -f qcow2 win10_clean.qcow2 100G
          
          # Lanzamos la VM con VNC en el puerto 5900
          # -display none: Oculta el Windows 11 host
          # -vnc :0: Abre la puerta para tu conexion directa
          Start-Process "C:\Program Files\qemu\qemu-system-x86_64.exe" -ArgumentList `
            "-m 10G", `
            "-smp 4,cores=4", `
            "-cpu host,kvm=off,hv_vendor_id=null", `
            "-drive file=win10_clean.qcow2,format=qcow2", `
            "-cdrom win10.iso", `
            "-vga virtio", `
            "-display none", `
            "-vnc :0", `
            "-net nic,model=e1000", `
            "-net user", `
            "-accel whpx"

      - name: üåê 3. CONECTAR T√öNEL Y MOSTRAR IP
        shell: powershell
        run: |
          # Tu Token de Ngrok ya configurado
          $NGROK_TOKEN = "377nhcufrMXbsEoPizYP8xnS22I_WaaTwHifh1DN6doMG5jU"
          
          Write-Host "[*] Configurando Ngrok..." -ForegroundColor Yellow
          & ngrok config add-authtoken $NGROK_TOKEN
          
          # Creamos el tunel TCP al puerto 5900 (VNC)
          Start-Process ngrok -ArgumentList "tcp 5900"
          
          Start-Sleep -Seconds 15
          
          # Extraemos la IP publica para que te conectes
          $ngrok_url = (curl.exe -s http://localhost:4040/api/tunnels | ConvertFrom-Json).tunnels[0].public_url
          
          Write-Host "################################################" -ForegroundColor Green
          Write-Host "CONECTATE A TU WINDOWS 10 USANDO ESTA DIRECCION:" -ForegroundColor Cyan
          Write-Host "IP: $ngrok_url" -ForegroundColor White
          Write-Host "################################################" -ForegroundColor Green
          Write-Host "Instrucciones: Abre TightVNC o VNC Viewer y pega esa IP."
          
          # Mantenemos vivo por 6 horas
          while($true) { Start-Sleep -Seconds 60 }
          
